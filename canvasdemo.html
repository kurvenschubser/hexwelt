<!--
HTML Canvas element demo
-->

<head>
<title>HTML Canvas element demo</title>
<script src="general.js" type="application/javascript;version=1.8"></script>
<script src="geometry.js" type="application/javascript;version=1.8"></script>
<script src="datastructures.js" type="application/javascript;version=1.8"></script>
<script src="game.js" type="application/javascript;version=1.8"></script>
<script src="render.js" type="application/javascript;version=1.8"></script>
<script src="windows.js" type="application/javascript;version=1.8"></script>
<script src="events.js" type="application/javascript;version=1.8"></script>
<script src="resources.js" type="application/javascript;version=1.8"></script>

<script type="application/javascript;version=1.8">
	"use strict";


	// Wrapper to construct callback for event 'onmouseover'
	function highlightBoardCursor(renderer)
	{
		var board = renderer.board;
		var window = renderer.parent;
		return function(event, info)
		{
			var p = info["coords"];
			if (p)
			{
				var boundingBox = renderer.parent.getBoundingBox()
				var boardArea = renderer.getBoardArea();
				var pp = new Point(p.x - boundingBox.x, p.y - boundingBox.y);	
				if (boardArea.containsPoint(pp))
				{
					pp.x -= boardArea.x;
					pp.y -= boardArea.y;
					var boardCoords = mapd2b(renderer, pp.x, pp.y);
					var highlightLayer = board.layers.getItem("highlight");
					highlightLayer.clear();
					if (boardCoords)
					{
						var tile = board.tiles[boardCoords[1]][boardCoords[0]];
						if (tile)
							highlightLayer.push(tile);	
					}
					board.updateEvent.fire({"target": board});
				}
			}
		}
	}

	function mapBoardCoordinatesToCanvasCoordinates(board, canvas)
	{
		
	}
	var mapb2c = mapBoardCoordinatesToCanvasCoordinates;


	function mapDisplayCoordinatesToBoardCoordinates(renderer, cx, cy)
	{
		var board = renderer.board;
		var scales = renderer.getScales();
		var row = trueDiv(cy, scales[1] * 1.5);
		var col = trueDiv(cx - (row % 2) * scales[0] * UNITY_HEXWIDTH, scales[0] * UNITY_HEXWIDTH * 2);
		var hex = new Hexagon((col + (row % 2) * 0.5) * scales[0] * UNITY_HEXWIDTH * 2, row * scales[1] * 1.5, scales[1]);

		if (hex.containsPoint(new Point(cx, cy)))
		{
			
			//return [col, row];
		}
		else
		{
			var center = hex.getCenter();
			if (cx < center.x)
			{
				if (row % 2)
				{
					row -= 1;
				}
				else
				{
					col -= 1;
					row -= 1;
				}
			}
			else
			{
				if (row % 2)
				{
					col += 1;
					row -= 1;
				}
				else
				{
					row -= 1;
				}
			}
		}
		if (!(-1 < col && col < board.cols && -1 < row && row < board.rows))
			return;
		return [col, row];
	}
	var mapd2b = mapDisplayCoordinatesToBoardCoordinates;


	function run()
	{
		var images = new ImagePreFetcher(["eagle.jpg", "dragon.png"]).fetch();
		var tiles = [
			[
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile()
			],
			[
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile()
			],
			[
				new Tile()
			],
			[
				new Tile()
			],
			[
				new Tile(),
				new Tile()
			],
			[
				new Tile(),
				new Tile(),
				new Tile()
			],
			[
				new Tile(),
				new Tile()
			],
			[
				new Tile(),
				new Tile()
			],
			[
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile()
			],
			[
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile()
			],
			[
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile()
			],
			[
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile(),
				new Tile()
			]
		];
		var board = new Board(tiles);
		board.addTilesToLayer("background", tiles);
		board.addTilesToLayer("grid", tiles);
		board.addTilesToLayer("highlight", [[tiles[1][1]]]);

		var renderer = new BoardRenderer(board, images["eagle.jpg"]);
		var window = new Window(renderer);
		window.setBoundingBox(20, 20, 300, 300);
		window.background = "lightpink";
		var canvas = document.getElementById("DemoCanvas");
		canvas.width = 600;
		canvas.height = 400;
		var CANVAS_OFFSET = getElementOffset(canvas);
		var ctx = canvas.getContext("2d");

		// begin of events
		var onMouseMoveEvent = new Event(
			"onmousemove", 
			[showCursorCoordinates("Coordinates"), highlightBoardCursor(renderer)],
			function(event, info)
			{
				var rect = new Rectangle(CANVAS_OFFSET[0], CANVAS_OFFSET[1], 
															info["caller"].width, info["caller"].height);
				var p = new Point(event.pageX - CANVAS_OFFSET[0], event.pageY - CANVAS_OFFSET[1]);
				if (rect.containsPoint(p))
					info["coords"] = p;
			},
			function(event, info)
			{
				window.render(ctx);
			}
		)
		canvas.onmousemove = onMouseMoveEvent.getCallable();

		board.updateEvent = new Event(
			"updateEvent",
			[function(event, info){ window.render(ctx) }]
		);

		window.render(ctx);
	}


	function showCursorCoordinates(targetId)
	{
		var target = document.getElementById(targetId)
		return function(event, info)
		{
			var p = info["coords"];
			if (p)
			{
				target.innerHTML = "(" + p.x + "," + p.y + ")";
			}
		}
	}


	function toggleGridDirection()
	{
		alert("Not implemented");
	}

</script>

</head>
<body onload="run()">
<h1 style="font: italic 2em Helvetica;">Canvas Demo (built for Gecko >= 3)</h1>
<div>
	<canvas id="DemoCanvas" style="border: 0px solid black;">Your browser does not support the canvas element.</canvas>
	<div id="Coordinates">(0,0)</div>
	<div>
		Grid direction: <span id="LabelGridDirection">horizontal</span>
	</div>
	<button id="ButtonToggleGridDirection" onclick="toggleGridDirection()">Toggle grid direction</button>
</div>
</body>

